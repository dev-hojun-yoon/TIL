# 25. 8. 14 (Thurs)

* ElasticSearch
  * index template 기능을 사용해 번거로울 수 있는 설정 작업을 쉽게 한다.
    * 고정된 조각의 template 를 생성할 수도 있고, 동적 template 를 생성할 수 있음
  * Kibana
    * stack management > Index Lifecycle Pipelines 에서 공통 설정 가능
    * stack management > snapshot and restore > register repository
  * python 이용한 elasticsearch-dsl 을 통해 인덱스에 접근할 수 있고,
  * "eland" 를 통해 dataframe 형식으로 elastic search 를 다룰 수 있다.
  * 요즘 AI 모델 서빙 등의 역할로 elastic search 를 사용하고 있으니 활용도에 대해 계속 생각해보기
  * docker compose 로 kibana 및 elasticsearch cluster 가 제대로 안올라오는 문제가 있었음
    * 용량 문제로 docker container 와 image 를 외장 SSD 에 저장
    * "cluster.routing.allocation.disk.threshold_enabled" compose 옵션은 Elasticsearch 클러스터의 디스크 용량 기반 샤드 재배치(Shard Allocation) 제한을 끄는 옵션
    * true 이면, 노드의 디스크 사용량이 일정 임계값을 넘으면 자동으로 새로운 샤드를 그 노드에 할당하지 않거나 기존 샤드를 다른 노드로 옮기는 것이다.
    * 충분한 용량 (30 GB) 인데도 디스크 부족 경고가 뜨는 것은 윈도우 + Docker Desktop + WSL2 환경에서 자주 발생하는 현상
    * C:\Users\Hojun Yoon\AppData\Local\Docker\wsl\disk 경로로 접근하면 symbolic link 가 외장 SSD 로 설정돼있음
    * 해당 경로에 있는 docker_data.vhdx 에 대해 속성으로 크기를 확인하면 8,970,567,680 (8.35 GB) 으로 아래 값과 동일함.. 이 값은 동적 확장 (dynamic expansion) 으로 실제 사용량에 따라 다르다고 함.
    * powershell 에서 Get-ChildItem "C:\Users\Hojun Yoon\AppData\Local\Docker\wsl\disk\docker_data.vhdx" | Select-Object Name, Length 를 확인하면 8,970,567,680 (8.35 GB)
    * wsl -d docker-desktop df -h / 에서 /dev/sdd               1006.9G     56.3M    955.6G   0% / 으로 사용률은 굉장히 미미함.
    * diskpart
      ```
      diskpart
      select vdisk file="C:\Users\<사용자이름>\AppData\Local\Docker\wsl\data\ext4.vhdx"
      detail vdisk
      
      장치 유형 ID: 0 (알 수 없음)
      공급업체 ID: {00000000-0000-0000-0000-000000000000} (알 수 없음)
      상태: 추가됨
      가상 크기: 1024 GB
      물리적 크기:    8 GB
      파일 이름: C:\Users\Hojun Yoon\AppData\Local\Docker\wsl\disk\docker_data.vhdx
      자식임: 아니요
      부모 파일 이름:
      연결된 디스크#: 찾을 수 없음.
      ```
    * WSL2의 docker_data.vhdx 는 동적 확장이어서 현재는 8.35GB만 디스크에서 차지하는데 내부에서는 1TB짜리 디스크처럼 보여서 디스크 크기 자체는 용량 부족 원인이 아니다.
    * 즉, ElasticSearch 디스크 용량 경고는 물리적인 NTFS/SSD 여유 공간이 아닌 container 에서 마운트된 경로의 파일 시스템 사용률을 기준으로 판단
    * WSL 내부 (1TB) 대신 마운트된 C 드라이브 여유 용량을 체크
    * window 경로가 WSL 에서 drvfs 로 마운트될 경우 "ES 가 읽은 값이 예상보다 작거나 특정 OS 계층에서 잘못 보고" 될 수 있음
      * drvfs 란 WSL 과 windows 파일 시스템 간의 상호 운용성을 지원하도록 설계된 WSL 파일 시스템 플러그인
      * drvFs 를 이용해서 WSL 이 /mnt 아래에 지원되는 파일 시스템이 있는 드라이브를 탑재할 수 있음
 
* 기타
  * docker 명령어
    * docker compose up --build // docker-compose.yml 에 세팅된 내용을 실행하면서 이미지 빌드까지 같이 수행
    * docker-compose.yml 설정 파일이 변경되었을 때는 docker compose down 후에 docker compose up 이 필요
  * logstash data stream true 방식 예시
    ```
      elasticsearch {
      hosts => ["http://localhost:9200"]
      data_stream => true
      data_stream_type => "logs"
      data_stream_dataset => "apache"
      data_stream_namespace => "default"
    }
    ```
  * logstash 실행 명령어 예시
    * bin\logstash -f config\logstash-pipeline-4.conf
  * 임베딩
    * 컴퓨터는 0, 1로 이해할 수 있으니 단어 간 관계를 행렬에 담긴 숫자로 표현 / 벡터로써 행렬로써 표현
  * LM studio // Ollama
    
