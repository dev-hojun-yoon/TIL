# 25. 8. 11 (Mon)

* elasticsearch aggregation
  * terms : 고유값을 뽑아낼 때 사용
  * extended_stats 필드 (혹은 stats - 축약형) 를 사용하면 주요 계산 정보를 모두 얻을 수 있다.
    * percentiles 는 백분율로 나타낸다.
    ```
    GET /kibana_sample_data_ecommerce/_search
    {
      "size": 0,
      "query": {
        "match": {
          "geoip.continent_name": "Africa"
        } 
      },
      "aggs": {
        "cal": {
          "extended_stats": {
            "field": "taxful_total_price"
          }
        }
      }
    }
    ```
  * 이외에도 bucket 집계 (하루 하루) / 파이프라인 집계 (특정 상황에 고정, 메트릭 확인
  * cardinality 현재 필드가 몇개의 고유값으로 구성되어 있는지 확인
    * 문서마다 난수화된 id, 대용량 데이터를 다루는 elasticsearch,, 정확한 집계값은 중요도가 낮을 수 있음
    * 완전히 일치하는 값이 아니라 어림짐작한 값으로도 충분히 문제를 해결할 수 있는 상황일 때, 대용량 처리 프로그램들은 메모리를 아끼는 대신 threshold 기준으로 각 doc 을 해싱한다.
    * 앞의 n 자리만 일치하는 값만 리턴한다고 이해
  * 집계 결과를 다시 쿼리에 사용할 수 있는 방법이 없다.
  * 버킷 집계: 특정 구간에 대한 대표값을 집계
    * 버킷 집계 내에서 다시 aggregation 을 수행할 수 있다.
      ```
      GET kibana_sample_data_flights/_search
        {
          "size": 0,
          "aggs": {
            "거리별 비행구간": {
              "range": { // from to 로 특정 구간을 작성
                "field": "DistanceKilometers",
                "ranges": [
                  {"to": 5000},
                  {
                    "from": 5000,
                    "to": 10000
                  },
                  {"from": 15000}
                ]
              },
              "aggs": {
                "평균 비행기 티켓 가격 - 거리별비행구간 기준": {
                    "avg": {
                      "field": "AvgTicketPrice"
                    }
                }
              }
            }
          }
        }
      ```
    * 같은 간격으로 bucket 을 지정 - histogram - interval 로 변환 가능
    * 0으로 떨어지지 않는 음수 구간을 설정할 때는 offset이라는 파라미터를 사용합니다.
    * 시간 구간은 calendar_interval 파라미터 사용
      ```
      GET kibana_sample_data_flights/_search
      {
        "size": 0,
        "aggs": {
          "일일 평균 비행기 티켓": {
            "date_histogram": {
              "field": "timestamp",
              "calendar_interval": "day",
              "format": "yyyy-MM-dd"
            },
            "aggs": {
              "일일 평균 비행기 티켓 금액": {
                "avg": {
                  "field": "AvgTicketPrice"
                }
            }
            }
            
          }
        }
      }
      ```
  * terms 집계
    * 용어로 집계한다, keyword 타입에서만 사용 가능하다. text 타입은 제대로 집계할 수 없을 것임
    * 빈도 수가 높은 것, 값이 큰 것을 우선적으로 표시
    * group by 역할을 수행할 수 있음
  * 합성 집계 composite
    * terms 집계한 내용을 대상으로 day 로 다시 집계를 할 수 있다.
      ```
      GET kibana_sample_data_logs/_search
      {
        "size": 0,
        "query": {
          "match_all": {}
        },
        "aggs": {
          "composite-aggs": {
            "composite": {
              "size": 100, 
              "sources": [
                {
                  "terms-aggs": {
                    "terms": {
                      "field": "host.keyword"
                    }
                  }
                },
                {
                  "date-histogram-aggs": {
                    "date_histogram": {
                      "field": "@timestamp",
                      "calendar_interval": "day"
                    }
                  }
                }
              ]
            }
          }
        }
      }
      ```
      * 합성 집계는 페이지네이션으로서 after 키를 사용할 수 있음
  * pipeline 집계
    * 첫번째 집계된 내용을 다음 집계에서 사용
    * cumulative_sum : 누적합 등
    * 일자별로 판매액은 어떻게 되는지, 그게 더해져서 총 매출액은 얼마인지 확인할 때
      ```
      POST kibana_sample_data_ecommerce/_search
      {
        "size": 0,
        "query": {
          "match_all": {}
        }, 
        "aggs": {
          "일자별": {
            "date_histogram": {
              "field": "order_date",
              "calendar_interval": "day"
            },
            "aggs": {
              "평균구매개수": {
                "avg": {
                  "field": "total_quantity"
                }
              }
            }
          },
          "일자별평균구매개수가가장많은날": {
            "max_bucket": {
              "buckets_path": "일자별>평균구매개수" 
            }
          },
          "일자별평균구매개수가가장적은날": {
            "min_bucket": {
              "buckets_path": "일자별>평균구매개수" 
            }
          }
        }
      }
      ```
  * 문자열은 term 집계를 한다.
