# 25. 8. 7 (Thurs)

* ElasticSearch
  * 인덱스를 생성할 때 PUT 메소드를 사용한다.
  * POST /{인덱스명}/_doc 메소드 호출로 문서를 생성
  * 전체 중에 일부 데이터만 수정해야하는 경우
    ```
    POST /my-index3/_update/12
    {
      "doc": {
        "document_number": 4
      }
    }
    ```
  * 전체 데이터를 수정하는 경우 (나머지 필드가 모두 날라가고 document_number 필드만 남아 있음
    ```
    PUT /my_index3/_doc/{id}
    {
      "document_number": 4
    }
    ```
  * unix time 을 지정하였지만, 별도로 형 지정을 하지 않으면 long type 으로 저장
  * name 은 string 으로 지정하였는데 아래와 같이 text, keyword 가 모두 커버가 가능하도록 지정됨.
    ```
    "name": {
          "type": "text",
          "fields": {
            "keyword": {
              "type": "keyword",
              "ignore_above": 256
            }
          }
        }
    ```
  * 복합 자료형도 심플자료형과 같은 방식으로 검색한다.
  * object 타입은 세부 요소가 모두 같은 타입으로 통일돼야 한다.
  * object 와 nested 타입의 차이점
    * nested 데이터 검색 예시 (인덱스 내의 별도의 doc 으로 관리횐다.) // 내부적으로 doc 안에 평탄화되는 object 와 비교
      부득이하게 students 필드를 doc 안의 doc 으로 관리해야 하는 경우
      ```
      PUT woorifisa_nested_test
      {
        "mappings": {
        "properties": {
          "students": {
            "type": "nested",
            "properties": {
              "name": {
                "type": "keyword"
              },
              "age": {
                "type": "long"
              }
            }
          }
        }
      }
      }

      # 검색 방법
      GET woorifisa_nested_test/_search
      {
        "query": {
          "nested": {
            "path": "student",
            "query": {
              "match": {
                "student.name": "신짱구"
              }
            }
          }
        }
      }
      ```
  * 모든 인덱스는 settings / mappings 2개의 정보 단위를 갖고 있음.
    * mappings : 문서가 어떻게 색인되고 저장되는지 정의 / SQL 자료형
  * 필드 타입
    * 심플 타입: text, keyword, date, long, double, boolean, ip
    * 계층 구조 지원 타입: object, nested
    * 그 외 타입: geo_point, geo_shape
  * 미리 명시적으로 타입을 지정한 경우 검색 시 주의
    * 원본을 그대로 저장하는데,
    * 타입은 정수형인데 40.6 데이터를 넣었을 때 40까지만 검색이 가능하므로 40.6 으로 조회는 불가능하니 주의
  * 검색 방식은 URI 검색과 Request Body 검색의 2가지 방법이 있음
  * 검색을 위한 query
    * term 쿼리와 match 쿼리
      * term (정확한 값)
        * 관련 타입 : keyword / numeric / boolean
      * match (단어 기반 / 토큰화)
        * 관련 타입 : text
    * Query DSL (domain specific language) : 쿼리를 통해 검색하는 방식
      * match (full text)
        * match_all, match, match_phrase, query_string
        * match_all 은 모든 문서에서 조회하는 것으로 생략 가능
        * match : text 타입 필드에서 해당 문자열이 포함되어 있는지 확인
        * query_string : URI 요청 방식과 유사 // 주소줄에 달아보내는 것과 같은 방식 동작 - * 모든문자, ? 한글자
          * 패턴 검색 등
            ```
            GET test/_search
            {
              "query": {
                "query_string": {
                  "default_field": "address",
                  "query" : "h*"
                }
              }
            }
            ```
      * bool query
        * must, must_not, should, filter
    * 여러개 쿼리를 한번에 작업하고 싶으면 -> _bulk
      * POST _bulk // default 인덱스는 test
      * 개행문자가 삽입되지 않도록 주의
      * GET test/_mappings, GET test/_settings 으로 세팅 내용 확인 가능
